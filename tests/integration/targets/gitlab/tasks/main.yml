####################################################################
# WARNING: These are designed specifically for Ansible tests       #
# and should not be used as examples of how to write Ansible roles #
####################################################################

- name: Install required libs
  pip:
    name: python-gitlab
    state: present

- name: get gitlab initial_root_password
  ansible.builtin.shell: |
    docker exec gitlab cat /etc/gitlab/initial_root_password | grep 'Password:' | sed -e 's/Password\: \(.*\)/\1/'
  register: initial_root_password

- name: create gitlab oath token
  ansible.builtin.uri:
    url: "{{ gitlab_external_url }}/oauth/token"
    method: POST
    body_format: form-urlencoded
    body:
      grant_type: password
      username: root
      password: "{{ initial_root_password.stdout }}"
  register: gitlab_oauth_token

- name: set gitlab auth header
  set_fact:
    gitlab_auth_header:
      Authorization: "Bearer {{ gitlab_oauth_token.json.access_token }}"

- name: create gitlab api token
  ansible.builtin.uri:
    url: "{{ gitlab_external_url }}/api/v4/users/1/personal_access_tokens"
    method: POST
    headers: "{{ gitlab_auth_header }}"
    body_format: json
    body:
      name: api
      scopes:
        - api
    status_code: 201
  register: gitlab_api_token

- name: create gitlab project
  gitlab_project:
    api_url: "{{ gitlab_external_url }}"
    api_token: "{{ gitlab_api_token.json.token }}"
    name: my_first_project
    initialize_with_readme: True
    state: present
  register: gitlab_project_data

- name: print gitlab_project_data
  debug:
    msg: "{{ gitlab_project_data }}"
